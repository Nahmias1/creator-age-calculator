<!DOCTYPE html>
<html>
<head>
  <title>Creator Works Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #121212;
      color: white;
      text-align: center;
      padding: 20px;
    }

    input {
      padding: 10px;
      width: 260px;
      background: #1e1e1e;
      color: white;
      border: 1px solid #333;
      border-radius: 6px;
    }

    button {
      padding: 10px 16px;
      margin: 6px;
      background: #2d2d2d;
      color: white;
      border: 1px solid #444;
      cursor: pointer;
      border-radius: 6px;
    }

    #imageArea img {
      width: 160px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    #worksList {
      margin-top: 30px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }

    h3 {
      border-bottom: 1px solid #333;
      padding-bottom: 6px;
      margin-top: 30px;
    }

    ul { list-style: none; padding: 0; }

    li {
      padding: 8px 0;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .year { color: #888; }
    .age { color: #777; }

    a { color: #9ecbff; text-decoration: none; }
    a:hover { text-decoration: underline; }

    @media (max-width: 600px) {
      li { flex-direction: column; }
    }
  </style>
</head>

<body>

<h1>Creator Works Explorer</h1>

<input id="creatorInput" placeholder="Creator name"><br>
<button onclick="loadWorks('ASC')">Ascending</button>
<button onclick="loadWorks('DESC')">Descending</button>

<div id="imageArea"></div>
<div id="creatorInfo"></div>
<div id="worksList"></div>

<script>

function formatDate(timeString) {
  const clean = timeString.replace("+","").split("T")[0];
  const parts = clean.split("-");
  const months = ["January","February","March","April","May","June",
                  "July","August","September","October","November","December"];
  return months[parseInt(parts[1])-1] + " " + parts[2] + ", " + parts[0];
}

async function loadWorks(order) {

  const name = document.getElementById("creatorInput").value.trim();
  if (!name) return;

  const imageArea = document.getElementById("imageArea");
  const creatorInfo = document.getElementById("creatorInfo");
  const worksDiv = document.getElementById("worksList");

  imageArea.innerHTML = "";
  creatorInfo.innerHTML = "";
  worksDiv.innerHTML = "Loading...";

  try {

    // 1️⃣ Search creator
    const searchRes = await fetch(
      `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(name)}&language=en&format=json&origin=*`
    );

    const searchData = await searchRes.json();
    if (!searchData.search.length) {
      worksDiv.innerHTML = "Creator not found.";
      return;
    }

    const creatorId = searchData.search[0].id;

    // 2️⃣ Get details
    const detailsRes = await fetch(
      `https://www.wikidata.org/wiki/Special:EntityData/${creatorId}.json`
    );

    const details = await detailsRes.json();
    const entity = details.entities[creatorId];

    const birth = entity.claims.P569?.[0]?.mainsnak?.datavalue?.value?.time;
    const birthYear = birth ? parseInt(birth.substring(1,5)) : null;
    const death = entity.claims.P570?.[0]?.mainsnak?.datavalue?.value?.time;
const deathYear = death ? parseInt(death.substring(1,5)) : null;

    const creatorLabel = entity.labels.en?.value || name;

    let wikiURL = "";
    if (entity.sitelinks?.enwiki) {
      wikiURL = "https://en.wikipedia.org/wiki/" +
                entity.sitelinks.enwiki.title.replace(/ /g,"_");
    }

    const creatorImage = entity.claims.P18?.[0]?.mainsnak?.datavalue?.value;

    if (creatorImage) {
      const img = document.createElement("img");
      img.src =
        `https://commons.wikimedia.org/wiki/Special:FilePath/${creatorImage.replace(/ /g,"_")}`;
      imageArea.appendChild(img);
    }

    creatorInfo.innerHTML =
      `<h2>${wikiURL
        ? `<a href="${wikiURL}" target="_blank">${creatorLabel}</a>`
        : creatorLabel}</h2>
       <div><strong>Born:</strong> ${birth ? formatDate(birth) : "Unknown"}</div>`;

    // 3️⃣ Work Fetch Function
    async function fetchWorks(property, instanceFilter) {

      const query = `
        SELECT DISTINCT ?work ?workLabel ?date ?article WHERE {
          ?work wdt:${property} wd:${creatorId}.
          ${instanceFilter}
          OPTIONAL { ?work wdt:P577 ?date. }

          OPTIONAL {
            ?article schema:about ?work ;
                     schema:isPartOf <https://en.wikipedia.org/>.
          }

          SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
        }
      `;

      const res = await fetch(
        "https://query.wikidata.org/sparql?format=json&query=" +
        encodeURIComponent(query)
      );

      const data = await res.json();
      const map = new Map();

      data.results.bindings.forEach(item => {

        if (!item.date || !item.workLabel) return;

        const title = item.workLabel.value;

        // Remove Wikidata Q garbage
        if (title.startsWith("Q")) return;

        const year = parseInt(item.date.value.substring(0,4));
        const link = item.article ? item.article.value : null;

        if (!map.has(title)) {
          map.set(title, { year, title, link });
        }

      });

      let works = Array.from(map.values());

      works.sort((a,b) =>
        order === "ASC" ? a.year - b.year : b.year - a.year
      );

      return works;
    }

    // 4️⃣ Fetch categories
    const directed = await fetchWorks("P57", "?work wdt:P31 wd:Q11424.");
    const acted = await fetchWorks("P161", "?work wdt:P31 wd:Q11424.");
    const books = await fetchWorks("P50", "");

    function buildSection(title, items) {
      if (!items.length) return "";
      let html = `<h3>${title}</h3><ul>`;
      items.forEach(w => {
        let age = "";

if (birthYear) {
  if (deathYear && w.year > deathYear) {
    age = "posthumous";
  } else {
    age = w.year - birthYear;
  }
}
        const titleHTML = w.link
          ? `<a href="${w.link}" target="_blank">${w.title}</a>`
          : w.title;

        html += `<li>
          <span class="year">${w.year}</span>
          <span>${titleHTML}</span>
          <span class="age">(${age})</span>
        </li>`;
      });
      html += "</ul>";
      return html;
    }

    worksDiv.innerHTML =
      buildSection("Directed", directed) +
      buildSection("Acted", acted) +
      buildSection("Books", books);

  } catch (error) {
    worksDiv.innerHTML = "Error loading works.";
    console.error(error);
  }
}

</script>

</body>
</html>
